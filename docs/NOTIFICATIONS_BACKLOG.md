# بكلوق الإشعارات (Backend) – حسب الأدوار

## نظرة عامة

هذا الملف يحدد متطلبات الإشعارات في الباك اند للأدوار الثلاثة:
- **User** – المستخدم (العميل)
- **Admin** – المدير
- **Support** – الدعم الفني

---

## الوضع الحالي

| المكون | الحالة |
|--------|--------|
| جدول `notifications` (Laravel) | ✅ موجود |
| `NotificationController` (API) | ✅ يعرض إشعارات المستخدم الحالي فقط |
| `BookingConfirmationNotification` | ✅ يُرسل للمستخدم عند تأكيد الحجز (mail + database) |
| إشعارات خاصة بالأدمن | ❌ غير موجودة |
| إشعارات خاصة بالدعم الفني | ❌ غير موجودة |
| تصفية الإشعارات حسب الدور | ❌ غير مطبقة |

---

## 1. المستخدم (User)

### الإشعارات المطلوبة

| # | نوع الإشعار | الوصف | القناة | الأولوية |
|---|-------------|--------|--------|----------|
| 1 | تأكيد الحجز | عند تأكيد الحجز (موجود حالياً) | database + mail | عالية |
| 2 | إلغاء الحجز | عند إلغاء حجزه (منه أو من الإدارة) | database + mail (حسب الإعدادات) | عالية |
| 3 | تذكير بالرحلة | تذكير قبل الرحلة بعدد ساعات (من الإعدادات) | database + mail (حسب الإعدادات) | متوسطة |
| 4 | رد على تذكرة دعم | عند رد الدعم/الأدمن على تذكرته | database | عالية |
| 5 | إغلاق تذكرة دعم | عند إغلاق تذكرته | database | متوسطة |
| 6 | رد على تقييمه | عند رد الإدارة على تقييمه | database | منخفضة |
| 7 | عرض جديد | إشعار بعروض جديدة (اختياري) | database | منخفضة |

### API الحالي (مشترك لجميع المسجلين)

- `GET /api/notifications` – قائمة إشعارات المستخدم الحالي
- `POST /api/notifications/{id}/read` – تعليم كمقروء
- `POST /api/notifications/read-all` – تعليم الكل كمقروء

**ملاحظة:** لا يحتاج تغيير مسارات؛ يحتاج فقط إضافة أنواع إشعارات جديدة وربطها بالأحداث في الباك اند.

---

## 2. المدير (Admin)

### الإشعارات المطلوبة

| # | نوع الإشعار | الوصف | القناة | الأولوية |
|---|-------------|--------|--------|----------|
| 1 | حجز جديد | عند إنشاء حجز جديد من أي مستخدم | database + mail (حسب الإعدادات) | عالية |
| 2 | إلغاء حجز | عند إلغاء مستخدم لحجزه | database | عالية |
| 3 | تذكرة دعم جديدة | عند فتح تذكرة دعم جديدة | database | عالية |
| 4 | رسالة جديدة في تذكرة | عند إرسال المستخدم رسالة في تذكرة مفتوحة | database | عالية |
| 5 | تقييم جديد | عند إضافة مستخدم تقييماً جديداً | database | متوسطة |
| 6 | دفع مكتمل | عند اكتمال دفع لحجز (إن وُجد حدث منفصل) | database | متوسطة |
| 7 | تنبيهات النظام | صيانة، أخطاء حرجة، نسخ احتياطي (اختياري) | database + mail | منخفضة |

### API مقترح

- استخدام نفس مسارات الإشعارات الحالية `GET/POST /api/notifications` مع التأكد أن الأدمن يرى إشعاراته فقط (حالياً يعمل كذلك لأن كل user له إشعاراته في جدول `notifications`).
- إذا لزم: إضافة فلتر اختياري حسب نوع الإشعار أو إضافة مسارات تحت `admin` مثل:
  - `GET /api/admin/notifications` – نفس الفكرة مع إمكانية فلترة إضافية للأدمن لاحقاً.

---

## 3. الدعم الفني (Support)

### الإشعارات المطلوبة

| # | نوع الإشعار | الوصف | القناة | الأولوية |
|---|-------------|--------|--------|----------|
| 1 | تذكرة دعم جديدة | عند فتح مستخدم لتذكرة جديدة | database | عالية |
| 2 | رسالة جديدة في تذكرة | عند إرسال المستخدم رسالة في تذكرة (خاصة المعينة له إن وُجد تعيين) | database | عالية |
| 3 | تعيين تذكرة له | عند تعيين الأدمن تذكرة له | database | متوسطة |
| 4 | إغلاق تذكرة كان يتابعها | عند إغلاق تذكرة كان معيناً عليها | database | منخفضة |

### API مقترح

- نفس الفكرة: استخدام `GET/POST /api/notifications` مع ضمان أن الدعم الفني يرى إشعاراته فقط (نفس جدول `notifications` مرتبط بـ user).
- إذا لزم: `GET /api/support/notifications` أو فلتر في نفس الـ endpoint حسب الدور.

---

## مهام التنفيذ (Backlog Items)

### مرحلة 1 – أساسيات (User)

- [ ] **N1** إشعار إلغاء الحجز (Database + اختياري Mail) للمستخدم عند إلغاء حجزه.
- [ ] **N2** إشعار تذكير بالرحلة (قبل X ساعات من الإعدادات) – Database + اختياري Mail.
- [ ] **N3** إشعار رد على تذكرة دعم – عند رد الدعم/الأدمن، إرسال إشعار database للمستخدم صاحب التذكرة.
- [ ] **N4** إشعار إغلاق تذكرة – عند إغلاق التذكرة، إرسال إشعار database للمستخدم.

### مرحلة 2 – الأدمن

- [ ] **N5** إشعار حجز جديد – عند إنشاء حجز، إرسال إشعار database (واختياري mail) لجميع المستخدمين بدور admin.
- [ ] **N6** إشعار إلغاء حجز – عند إلغاء مستخدم لحجزه، إشعار database للأدمن.
- [ ] **N7** إشعار تذكرة دعم جديدة – عند فتح تذكرة، إشعار database للأدمن (وللدعم في N8).
- [ ] **N8** إشعار رسالة جديدة في تذكرة – عند رسالة من المستخدم في تذكرة، إشعار database للأدمن والدعم (حسب التصميم).
- [ ] **N9** إشعار تقييم جديد – عند إضافة تقييم، إشعار database للأدمن.

### مرحلة 3 – الدعم الفني

- [ ] **N10** إشعار تذكرة جديدة للدعم – عند فتح تذكرة، إشعار database لجميع المستخدمين بدور support (أو توزيع لاحق).
- [ ] **N11** إشعار رسالة جديدة في تذكرة للدعم – عند رسالة من المستخدم، إشعار للدعم (وإن وُجد تعيين فالأولوية للمُعيَّن).
- [ ] **N12** إشعار تعيين تذكرة – عند تعيين الأدمن تذكرة لمستخدم دعم، إشعار database له.

### مرحلة 4 – تحسينات

- [ ] **N13** فلتر إشعارات حسب النوع في `GET /api/notifications` (مثلاً `?type=booking_confirmation`).
- [ ] **N14** عداد غير مقروء في الاستجابة أو endpoint منفصل `GET /api/notifications/unread-count` (إن لم يكن موجوداً في الفرونت).
- [ ] **N15** احترام إعدادات الإيميل (مثل `send_cancellation_email`, `send_booking_reminder_email`) عند إرسال إشعارات البريد.

---

## هيكل بيانات الإشعار (Database – حقل `data`)

يمكن توحيد شكل الـ `data` لكل نوع لتسهيل العرض في الفرونت:

```json
{
  "type": "booking_cancelled",
  "title_ar": "تم إلغاء الحجز",
  "message_ar": "تم إلغاء حجزك رقم NB123.",
  "action_url": "/dashboard",
  "related_type": "booking",
  "related_id": 5,
  "created_at": "2026-02-19T12:00:00Z"
}
```

أنواع مقترحة لـ `type`:

- `booking_confirmation`
- `booking_cancelled`
- `booking_reminder`
- `support_ticket_reply`
- `support_ticket_closed`
- `review_reply`
- `new_booking` (للأدمن)
- `new_support_ticket` (للأدمن/الدعم)
- `support_ticket_new_message` (للأدمن/الدعم)
- `support_ticket_assigned` (للدعم)
- `new_review` (للأدمن)

---

## ملخص الأدوار

| الدور | الإشعارات الأساسية |
|------|---------------------|
| **User** | تأكيد حجز، إلغاء حجز، تذكير رحلة، رد على تذكرة، إغلاق تذكرة، رد على تقييم |
| **Admin** | حجز جديد، إلغاء حجز، تذكرة جديدة، رسالة في تذكرة، تقييم جديد |
| **Support** | تذكرة جديدة، رسالة في تذكرة، تعيين تذكرة، إغلاق تذكرة |

يمكن استخدام هذا الملف كبكلوق لتطوير الإشعارات في الباك اند خطوة بخطوة حسب الأولوية.
